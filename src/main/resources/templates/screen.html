<!doctype html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="layout :: layout">
<head>
    <meta charset="utf-8" />
    <title th:text="${title}">Screen</title>
</head>
<body>
<section th:fragment="content" class="screen">
    <div class="form-card">
        <form method="post" class="form-body">
            <div th:replace="fragments/fields :: fields(${form})"></div>
            <div class="form-actions">
                <button type="submit" class="btn primary">Submit</button>
            </div>
        </form>
    </div>
    <!-- Lookup Modal -->
    <div id="lookup-overlay" class="lookup-overlay" aria-hidden="true" hidden></div>
    <div id="lookup-modal" class="lookup-modal" role="dialog" aria-modal="true" aria-labelledby="lookup-title" hidden>
        <div class="lookup-header">
            <h3 id="lookup-title" class="lookup-title">Zoek waarde</h3>
            <button type="button" class="btn secondary lookup-close" aria-label="Sluiten">×</button>
        </div>
        <div class="lookup-body">
            <input id="lookup-input" class="input" type="text" placeholder="Typ om te filteren..." />
            <ul id="lookup-list" class="lookup-list" role="listbox" aria-label="Zoekresultaten"></ul>
        </div>
        <div class="lookup-footer">
            <button type="button" class="btn secondary lookup-cancel">Annuleer</button>
        </div>
    </div>
    <script>
        (function(){
            var overlay = document.getElementById('lookup-overlay');
            var modal = document.getElementById('lookup-modal');
            var inputEl = document.getElementById('lookup-input');
            var listEl = document.getElementById('lookup-list');
            var closeBtns = [];
            // Failsafe: ensure overlay and modal start hidden even if cached CSS is stale
            if(overlay){ overlay.hidden = true; overlay.setAttribute('aria-hidden','true'); }
            if(modal){ modal.hidden = true; modal.setAttribute('aria-hidden','true'); }
            function qAll(sel){ return Array.prototype.slice.call(document.querySelectorAll(sel)); }
            function show(el){ el.hidden = false; el.setAttribute('aria-hidden','false'); }
            function hide(el){ el.hidden = true; el.setAttribute('aria-hidden','true'); }

            var currentCtx = null; // { url, wrapper, codeInput, hidden, nameSpan }

            function openModal(ctx){
                currentCtx = ctx;
                inputEl.value = (ctx.codeInput && ctx.codeInput.value) || '';
                renderList([]);
                show(overlay); show(modal);
                setTimeout(function(){ inputEl.focus(); inputEl.select(); }, 0);
                // lock body scroll while modal open
                try { document.body.style.overflow = 'hidden'; } catch(e) {}
                // Kick initial load
                fetchAndRender(inputEl.value);
            }

            function closeModal(){
                hide(modal); hide(overlay);
                // restore body scroll
                try { document.body.style.overflow = ''; } catch(e) {}
                if(currentCtx && currentCtx.codeInput){ currentCtx.codeInput.focus(); }
                currentCtx = null;
            }

            function renderList(items){
                listEl.innerHTML = '';
                items.forEach(function(it){
                    var li = document.createElement('li');
                    li.className = 'lookup-item';
                    li.setAttribute('role','option');
                    li.tabIndex = 0;
                    li.dataset.id = it.id || '';
                    li.dataset.code = it.code || '';
                    li.dataset.name = it.name || '';
                    li.textContent = (it.code ? it.code + ' — ' : '') + (it.name || '');
                    li.addEventListener('dblclick', function(){ selectItem(li); });
                    li.addEventListener('keydown', function(ev){ if(ev.key === 'Enter'){ selectItem(li); } });
                    listEl.appendChild(li);
                });
            }

            function fetchAndRender(query){
                if(!currentCtx || !currentCtx.url) return;
                var url = currentCtx.url + '?code=' + encodeURIComponent(query || '');
                fetch(url)
                    .then(function(r){ return r.ok ? r.json() : []; })
                    .then(function(list){ renderList(Array.isArray(list) ? list : []); })
                    .catch(function(){ renderList([]); });
            }

            var debTimer = null;
            inputEl.addEventListener('input', function(){
                clearTimeout(debTimer);
                var q = this.value;
                debTimer = setTimeout(function(){ fetchAndRender(q); }, 180);
            });

            function selectItem(li){
                if(!currentCtx) return;
                var code = li.dataset.code || '';
                var name = li.dataset.name || '';
                var id = li.dataset.id || code || '';
                if(currentCtx.codeInput) currentCtx.codeInput.value = code;
                if(currentCtx.nameSpan) currentCtx.nameSpan.textContent = name;
                if(currentCtx.hidden) currentCtx.hidden.value = id;
                closeModal();
            }

            document.addEventListener('click', function(e){
                var btn = e.target.closest('button.btn.icon[data-lookup-url]');
                if(btn){
                    var wrapper = btn.closest('.reference-field');
                    if(!wrapper) return;
                    var codeInput = wrapper.querySelector('input.input[data-lookup-url]') || wrapper.querySelector('input.input');
                    var nameSpan = wrapper.querySelector('.reference-name');
                    var hidden = wrapper.querySelector('input[type="hidden"]');
                    var url = btn.getAttribute('data-lookup-url') || (codeInput && codeInput.getAttribute('data-lookup-url'));
                    if(url){
                        openModal({ url: url, wrapper: wrapper, codeInput: codeInput, nameSpan: nameSpan, hidden: hidden });
                    }
                }
            });

            // Close interactions
            closeBtns = qAll('.lookup-close, .lookup-cancel');
            closeBtns.forEach(function(b){ b.addEventListener('click', closeModal); });
            overlay.addEventListener('click', closeModal);
            document.addEventListener('keydown', function(e){ if(e.key === 'Escape' && !modal.hidden){ closeModal(); } });
            // --- Submit handler: bouw DTO en log naar console ---
            var form = document.querySelector('form.form-body');
            if(form){
                form.addEventListener('submit', function(ev){
                    ev.preventDefault();
                    var dto = {};
                    // Verzamel alle input/select elementen
                    var fields = Array.prototype.slice.call(form.querySelectorAll('input, select, textarea'));
                    // Eerst reference velden herkennen via hidden inputs (deze dragen de echte field name)
                    var handledNames = new Set();
                    fields.forEach(function(el){
                        if(el.type === 'hidden'){
                            var name = el.name; // b.v. "postcode"
                            var wrapper = el.closest('.reference-field');
                            if(wrapper){
                                var codeInput = wrapper.querySelector('input.input[name="'+name+'_code"]');
                                var nameSpan = wrapper.querySelector('.reference-name');
                                dto[name] = {
                                    id: el.value || '',
                                    code: codeInput ? codeInput.value : '',
                                    name: nameSpan ? nameSpan.textContent : ''
                                };
                                handledNames.add(name);
                                handledNames.add(name + '_code');
                            }
                        }
                    });
                    // Voeg overige velden toe (excl. al verwerkte reference-onderdelen)
                    fields.forEach(function(el){
                        if(!el.name || handledNames.has(el.name)) return;
                        if(el.type === 'hidden') return; // hidden reeds verwerkt of niet bedoeld voor DTO
                        var val = el.value;
                        if(el.tagName === 'SELECT'){
                            val = el.value;
                        }
                        dto[el.name] = val;
                    });
                    // Eenvoudige console output
                    // Gebruik structured clone (JSON) voor nette weergave
                    try {
                        console.log('DTO submitted:', dto);
                        console.log('DTO (json):', JSON.stringify(dto, null, 2));
                    } catch(e) {
                        console.log('DTO submitted (raw):', dto);
                    }
                });
            }
        })();
    </script>
</section>
</body>
</html>
